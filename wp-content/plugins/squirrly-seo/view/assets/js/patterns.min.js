if(typeof SQ_DEBUG==="undefined")var SQ_DEBUG=false;var $sq_patterns=[];(function($){"use strict";$.fn.sq_patterns=function(){var $this=this;var settings={field:false,patternid:0,sq_pattern_icon:$('<div class="sq_pattern_icon" title="Click to edit/add more patterns"></div>'),sq_pattern_list:$('<div class="sq_pattern_list" style="display: none"><table><tr><th colspan="2">Click to insert a pattern:</th></tr></table></div>')};if($this.find("input[type=text]").length>0){settings.field=$this.find("input[type=text]")}else if($this.find("textarea").length>0){settings.field=$this.find("textarea")}if($this.data("patternid")){settings.patternid=$this.data("patternid")}settings.sq_pattern_icon.off("click");settings.sq_pattern_list.find("td.value").off("click");$this.init=function(){if(!$this.find(".sq_pattern_list").length){$this.append(settings.sq_pattern_list);var $snippet=$this.parents(".sq_blocksnippet:last");if(typeof $sq_patterns[settings.patternid]==="undefined"){$sq_patterns[settings.patternid]=$this.sq_getPatterns($snippet.find("input[name=sq_post_id]").val(),$snippet.find("input[name=sq_term_id]").val(),$snippet.find("input[name=sq_taxonomy]").val(),$snippet.find("input[name=sq_post_type]").val())}$sq_patterns[settings.patternid].done(function(response){if(typeof response!=="undefined"){if(typeof response.json!=="undefined"){$.sq_patterns_list=$.parseJSON(response.json);for(var pattern in $.sq_patterns_list){if(pattern==="{{page}}"||$.sq_patterns_list[pattern]["value"]!==""&&$.sq_patterns_list[pattern]["value"]!==null||!$snippet.find("input[name=sq_post_id]").val()&&!$snippet.find("input[name=sq_term_id]").val()){$this.find(".sq_pattern_list").find("table").append('<tr><td class="value" data-pattern="'+pattern+'" data-value="'+$.sq_patterns_list[pattern]["value"]+'" title="'+$.sq_patterns_list[pattern]["value"]+'"><span class="value">'+pattern+'</span></td><td class="details"> - '+$.sq_patterns_list[pattern]["details"]+"</td></td>")}}$this.selectPattern()}}else{SQ_DEBUG&&console.log("no data received")}})}};$this.listenIcon=function(){if(!$this.find(".sq_pattern_icon").length){$this.append(settings.sq_pattern_icon);settings.sq_pattern_icon.on("click",function(){settings.sq_pattern_list.toggle();if(settings.sq_pattern_list.is(":visible")){settings.sq_pattern_icon.addClass("sq_opened");$this.selectPattern();settings.field.off("change").on("change",function(){$this.selectPattern()});settings.sq_pattern_list.find("td.value").off("click").on("click",function(){$this.selectPattern($(this).data("pattern"))})}else{settings.sq_pattern_icon.removeClass("sq_opened")}})}};$this.selectPattern=function(pattern){var words=[];if(typeof pattern!=="undefined"){var value=settings.field.val();if(pattern!=="{{sep}}"&&value.indexOf(pattern)!==-1){value=value.replace(pattern,"").replace("  "," ").trim()}else{if(value.split(" ").pop()!==pattern){value=(value+" "+pattern).trim()}else{value=value.substring(0,value.lastIndexOf(pattern)).trim()}}settings.field.val(value)}if(settings.field.val().length>1){words=settings.field.val().split(" ")}settings.sq_pattern_list.find("td.value").each(function(){$(this).removeClass("sq_patterns_selected")});if(words.length>0){for(var i=0;i<words.length;i++){if(words[i].match(/{{[a-z_]+}}/g)){settings.sq_pattern_list.find("td.value").each(function(){if(words[i]===$(this).data("pattern")){$(this).addClass("sq_patterns_selected")}})}}}if($.fn.highlightWithinTextarea){settings.field.highlightWithinTextarea({highlight:/({{[^\}]+}})/g})}if($.fn.sq_checkMax){settings.field.sq_checkMax()}};$this.highlightListen=function(){settings.field.highlightWithinTextarea({highlight:/({{[^\}]+}})/g});settings.field.off("change").on("change",function(){$(this).highlightWithinTextarea({highlight:/({{[^\}]+}})/g})})};if(settings.field){$this.listenIcon();$this.highlightListen()}return $this};$.fn.sq_getPatterns=function(post_id,term_id,taxonomy,post_type){var $this=this;$this.addClass("sq_minloading");return $.post(sqQuery.ajaxurl,{action:"sq_getpatterns",post_id:post_id,term_id:term_id,taxonomy:taxonomy,post_type:post_type,sq_nonce:sqQuery.nonce}).done(function(response){$this.removeClass("sq_minloading")}).fail(function(){$this.removeClass("sq_minloading")})};$(document).ready(function(){$(".sq_pattern_field").each(function(){$(this).sq_patterns().init()})})})(jQuery);